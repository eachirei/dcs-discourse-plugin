import {withPluginApi} from 'discourse/lib/plugin-api';import {Bellhop} from './bellhop';import {NotificationLevels} from 'discourse/lib/notification-levels';import User from 'discourse/models/user';import {setDefaultHomepage} from 'discourse/lib/utilities';import SiteHeaderComponent from 'discourse/components/site-header';import Composer from 'discourse/models/composer';import ComposerController from 'discourse/controllers/composer';import ApplicationRoute from 'discourse/routes/application';var n=()=>{let a="Docuss";a="undefined"!==typeof window?window.name.trim()||document.title.trim()||a:require(__dirname+"/package.json").name||a;return a.substring(0,12)},p=(...a)=>{a=[`%c${n()} %c- Docuss Error -`,"color:grey","color:red",...a];console.log(...a)};class q extends Error{constructor(a){super(a);this.name="DocussError"}}var r=a=>{throw new q(a);},t=(a,b)=>{if(!a)throw new q(`Assertion Failed${b?" - "+b:""}`);};
function u(a,b,c,d,e=0){let f=(k,l)=>{try{const m=b(a[e],e,a);m&&m.then?m.then(k).catch(l):k(m)}catch(m){l(m)}},h=(k,l)=>()=>u(a,b,k,l,++e),g=(k,l)=>e<a.length?(new Promise(f)).then(h(k,l)).catch(l):k();return c?g(c,d):new Promise(g)}var v=(a,b)=>new Promise(c=>{setTimeout(()=>{c(b)},a)});function w(a,b,c,d){let e=f=>v(c).then(()=>a(f));try{return 0===b?Promise.reject(d):Promise.resolve(a(b)).then(f=>f||w(e,b-1))}catch(f){return Promise.reject(f)}}
var x=(a,b)=>a&&0!==a.length?Promise.resolve(b(a[0])).then(c=>c?a[0]:x(a.slice(1),b)):Promise.resolve(void 0);function y(a,b){let c=a.T.siteSettings.docuss_iframe_attributes;$(a.left).replaceWith(`
      <iframe id="dcs-left" frameborder="0" style="${a.left.style.cssText}" 
          src="${b}" ${c}>
      </iframe>
    `);a.left=document.getElementById("dcs-left")}function z(a,b,c,d){a.na.animate?(a=a.na.animate([{left:b},{left:c}],{duration:200}),d&&(a.onfinish=d)):d&&d()}function A(a,b){z(a,"100%",1035<=window.innerWidth?"50%":"0%",b)}
function B(a,b){switch(a.sa){case null:switch(b){case 0:$("html").attr("dcs-layout",b);break;case 1:$("html").attr("dcs-layout",b);break;case 2:$("html").attr("dcs-layout",b);break;case 3:$("html").attr("dcs-layout",b)}break;case 0:switch(b){case 1:$("html").attr("dcs-layout",b);break;case 2:$("html").attr("dcs-layout",b);break;case 3:A(a,()=>{$("html").attr("dcs-layout",b)})}break;case 1:switch(b){case 0:$("html").attr("dcs-layout",b);break;case 2:$("html").attr("dcs-layout",b);break;case 3:$("html").attr("dcs-layout",
b)}break;case 2:switch(b){case 0:$("html").attr("dcs-layout",b);break;case 1:$("html").attr("dcs-layout",b);break;case 3:A(a,()=>{$("html").attr("dcs-layout",b)})}break;case 3:switch(b){case 0:$("html").attr("dcs-layout",b);z(a,1035<=window.innerWidth?"50%":"0%","100%");break;case 1:$("html").attr("dcs-layout",b);break;case 2:$("html").attr("dcs-layout",b),z(a,1035<=window.innerWidth?"50%":"0%","100%")}break;default:throw new q(void 0);}a.T.site.set("mobileView",a.Ga||2===b||3===b);a.sa=b}
class C{constructor(a){this.T=a;this.Ga=a.site.mobileView;this.left=document.getElementById("dcs-left");this.na=document.getElementById("dcs-ghost");this.sa=null}}function D(){$("html").toggleClass("dcs-wide",1035<=window.innerWidth)}window.addEventListener("resize",D);D();
function E(a){var b=a.lookup("controller:application");let c="dcs2";b.siteSettings.docuss_hide_sugg_topics&&(c+=" dcs-disable-sugg");b.siteSettings.docuss_hide_categories&&(c+=" dcs-disable-cats");b.siteSettings.docuss_hide_hamburger_menu&&(c+=" dcs-no-ham-menu");b.siteSettings.docuss_hide_tags&&(c+=" dcs-hide-tags");$("html").addClass(c);$("body").prepend('\n    <div id="dcs-ghost">\n      <div class="dcs-ghost-splitbar"></div>\n    </div>\n    <div id="dcs-container">\n      <div id="dcs-ios-wrapper">\n        <div id="dcs-left">\n        </div>\n      </div>\n      <div id="dcs-splitbar">\n        <div style="flex:1 0 0"></div>\n        <div id="dcs-splitbar-text">&gt;</div>\n        <div style="flex:1 0 0"></div>\n      </div>\n    </div>\n  ');
$("#main-outlet").wrap('<div id="dcs-right"></div>');a.h=new C(b);let d=a.lookup("router:main");$("#dcs-splitbar").click(()=>{let e=!a.h.T.get("showRight");d.transitionTo({queryParams:{showRight:e}})});(b=User.current())&&b.admin&&$(document).keydown(function(e){65===e.keyCode&&e.altKey&&$("html").toggleClass("dcs-debug");66===e.keyCode&&e.altKey&&B(a.h,1)})}var F=/^[0-9A-Za-z_]+$/,G=null;
function H(a){t("number"===typeof a.A&&1<=a.A);t("number"===typeof a.J&&1<=a.J);t("boolean"===typeof a.ba);G=a}function I(){t(G,"DcsTag not initialized")}function J(){I();return G}function K({a,c:b}){if(!L(a,G.A))throw new q(`Invalid pageName "${a}"`);if(b&&!L(b,G.J))throw new q(`Invalid triggerId "${b}"`);return b?`${"dcs"}-${a}-${b}`:`${"dcs"}-${a}`}
function M(a){I();if("dcs-comment"===a||"dcs-discuss"===a)return null;var b=a.split("-");if("dcs"!==b.shift())return null;a=b.shift();return L(a,G.A)?(b=b.shift())&&!L(b,G.J)?null:{a,c:b}:null}function L(a,b){I();return a&&a.length<=b&&a.match(F)&&(!G.ba||a===a.toLowerCase())}function aa({g:a,M:b,R:c,N:d}){b.O.then(()=>{ba({g:a,M:b,N:d,R:c})}).catch(e=>{c.startsWith("docuss")?B(a.h,0):B(a.h,1);throw e;})}
function ba({g:a,M:b,R:c,N:d}){if(c.startsWith("topic.")){let e=a.lookup("route:topic").currentModel;w(()=>e.hasOwnProperty("tags"),15,200).then(()=>{N({g:a,M:b,R:c,N:d})},()=>{B(a.h,1)})}else N({g:a,M:b,R:c,N:d})}
function N({g:a,M:b,R:c,N:d}){if(c.startsWith("docuss"))d={b:0,a:(a.lookup("route:"+c).context||{}).page},O(b,d)||($("html").removeClass("dcs-tag dcs-topic dcs-comment dcs-discuss"),B(a.h,d.b));else{if("tags.intersection"===c){var e=a.lookup("route:tags.intersection"),f=e.currentModel;if("dcs-comment"===f.id||"dcs-discuss"===f.id)if(e=e.get("additionalTags")[0],e=M(e)){let {a:h,c:g}=e,k="dcs-comment"===f.id;f=k?"COMMENT":"DISCUSS";c=a.h.T.get("showRight")?3:2;if(O(b,{b:c,a:h,c:g,j:f}))return;d||(b=
k?"dcs-comment":"dcs-discuss",$("html").removeClass("dcs-tag dcs-topic dcs-comment dcs-discuss"),$("html").addClass(`dcs-tag ${b}`),P().then(()=>{{k&&$("#create-topic > .d-button-label").text("New Comment");let l=$("footer.topic-list-bottom");if(l.length){let m=`
      <div style="margin-left:12px">
        <p><i>No ${k?"comment":"topic"} yet</i></p>
      `;User.current()||(m+="<p>(you need to log in before you can create one)</p>");m+="</div>";l.html(m);$(".tag-notifications-button").hide()}}}));B(a.h,c);return}}if(c.startsWith("topic.")){c=a.lookup("route:topic").currentModel;f=c.tags||[];e=f.find(g=>"dcs-comment"===g||"dcs-discuss"===g);let h=f.find(g=>M(g));if(e&&h){let {a:g,c:k}=M(h),l=c.tags.includes("dcs-comment");f=l?"COMMENT":"DISCUSS";c=a.h.T.get("showRight")?3:2;if(O(b,{b:c,a:g,c:k,j:f}))return;d||(b=l?"dcs-comment":"dcs-discuss",
$("html").removeClass("dcs-tag dcs-topic dcs-comment dcs-discuss"),$("html").addClass(`dcs-topic ${b}`),P().then(()=>{l||$("#dcs-back").length||$('#main-outlet > .ember-view[class*="category-"]').prepend(`
      <div id="dcs-back" class="list-controls">
        <div class="container">
          <a style="line-height:28px" href="/tags/intersection/dcs-discuss/${h}">
            &#8630; Back to topic list
          </a>
        </div>
      </div>
    `)}));B(a.h,c);return}}$("html").removeClass("dcs-tag dcs-topic dcs-comment dcs-discuss");O(b,{b:1,pathname:location.pathname})||B(a.h,1)}}let P=()=>new Promise(a=>{Ember.run.schedule("afterRender",null,()=>a(void 0))});
function ca(a){_.chain(a).reject(b=>b.deleted||"private_message"===b.archetype).map(b=>({va:b.topic_id,Sa:null===b.last_read_post_number&&(0!==b.notification_level&&!b.notification_level||b.notification_level>=NotificationLevels.wa),Xa:null!==b.last_read_post_number&&b.last_read_post_number<b.highest_post_number&&b.notification_level>=NotificationLevels.wa?b.highest_post_number-b.last_read_post_number:0})).reject(b=>!b.isNewTopic&&!b.unreadPostCount).value()}
function da({K:a,ya:b,aa:c,f:d,origin:e}){Q.s.send("m2",{route:{layout:a.b,pageName:a.a,hash:a.hash,interactMode:a.j,triggerId:a.c,pathname:a.pathname},descr:b,counts:c,clientContext:d,origin:e})}
class ea{constructor(){this.s=new Bellhop;this.Z=this.C=null;this.s.on("connected",()=>{this.C&&(clearTimeout(this.C),this.C=null);this.Z&&this.Z()})}connect({za:a,Aa:b,Ca:c,timeout:d,Ta:e}){this.disconnect();this.Z=c;this.C=d?setTimeout(()=>{e&&e()},d):null;this.s.connect(a,b)}disconnect(){this.C&&(clearTimeout(this.C),this.C=null);this.s.disconnect()}isConnected(){return this.s.connected}ea(a){this.s.on("m4",b=>{a({K:R(b.data.route),mode:b.data.mode,f:b.data.clientContext})})}ga(a){this.s.on("m6",
b=>{a({D:b.data.category,U:b.data.discourseTitle,error:b.data.error})})}fa(a){this.s.on("m7",b=>{b=b.data.map(c=>({src:R(c.src),w:R(c.dest)}));a(b)})}da(a){this.s.on("m8",b=>{a({a:b.data.pageName,Ia:b.data.triggerIds,ca:b.data.notificationLevel})})}}let Q=new ea;
function R(a){let b={};"layout"in a&&(b.b=a.layout);"pageName"in a&&(b.a=a.pageName);"hash"in a&&(b.hash=a.hash);"interactMode"in a&&(b.j=a.interactMode);"triggerId"in a&&(b.c=a.triggerId);"pathname"in a&&(b.pathname=a.pathname);return b}
function fa(a){let b={};"$schema"in a&&(b.Ja=a.$schema);"websiteName"in a&&(b.S=a.websiteName);"logo"in a&&(b.I={},"logoUrl"in a.logo&&(b.I.V=a.logo.logoUrl),"mobileLogoUrl"in a.logo&&(b.I.W=a.logo.mobileLogoUrl),"smallLogoUrl"in a.logo&&(b.I.Y=a.logo.smallLogoUrl));"dcsTag"in a&&(b.H={},"maxPageNameLength"in a.dcsTag&&(b.H.A=a.dcsTag.maxPageNameLength),"maxTriggerIdLength"in a.dcsTag&&(b.H.J=a.dcsTag.maxTriggerIdLength),"forceLowercase"in a.dcsTag&&(b.H.ba=a.dcsTag.forceLowercase));"pages"in a&&
(b.o=a.pages.map(c=>{let d={};"name"in c&&(d.name=c.name);"url"in c&&(d.url=c.url);"needsProxy"in c&&(d.pa=c.needsProxy);return d}));"webApp"in a&&(b.l={},"otherPagesPrefix"in a.webApp&&(b.l.v=a.webApp.otherPagesPrefix));"redirects"in a&&(b.P=a.redirects.map(c=>{let d={};"src"in c&&(d.src={},"pageName"in c.src&&(d.src.a=c.src.pageName),"layout"in c.src&&(d.src.b=c.src.layout),"interactMode"in c.src&&(d.src.j=c.src.interactMode),"triggerId"in c.src&&(d.src.c=c.src.triggerId),"pathname"in c.src&&(d.src.pathname=
c.src.pathname));"dest"in c&&(d.w={},"pageName"in c.dest&&(d.w.a=c.dest.pageName),"layout"in c.dest&&(d.w.b=c.dest.layout),"interactMode"in c.dest&&(d.w.j=c.dest.interactMode),"triggerId"in c.dest&&(d.w.c=c.dest.triggerId),"pathname"in c.dest&&(d.w.pathname=c.dest.pathname));return d}));"clientData"in a&&(b.clientData={},"decorator"in a.clientData&&(b.clientData.L={},"category"in a.clientData.decorator&&(b.clientData.L.D=a.clientData.decorator.category),"discourseTitle"in a.clientData.decorator&&
(b.clientData.L.U=a.clientData.decorator.discourseTitle),"pageProperties"in a.clientData.decorator&&(b.clientData.L.Fa=a.clientData.decorator.pageProperties.map(c=>{let d={};"pageNames"in c&&(d.qa=c.pageNames.slice(0));"category"in c&&(d.D=c.category);"discourseTitle"in c&&(d.U=c.discourseTitle);return d})),"injectCss"in a.clientData.decorator&&(b.clientData.L.Oa=a.clientData.decorator.injectCss.map(c=>{let d={};"pageNames"in c&&(d.qa=c.pageNames.slice(0));"css"in c&&(d.css=c.css.slice(0));return d})),
"injectTriggers"in a.clientData.decorator&&(b.clientData.L.Ba=a.clientData.decorator.injectTriggers.map(c=>{let d={};"pageNames"in c&&(d.qa=c.pageNames.slice(0));"ids"in c&&(d.oa=c.ids.slice(0));"interactMode"in c&&(d.j=c.interactMode);"ui"in c&&(d.B={},"cssSelector"in c.ui&&(d.B.Ma=c.ui.cssSelector),"highlightable"in c.ui&&(d.B.Na=c.ui.highlightable),"insertTextSpan"in c.ui&&(d.B.Ra=c.ui.insertTextSpan),"insertBalloon"in c.ui&&(d.B.Pa=c.ui.insertBalloon),"insertCountBadge"in c.ui&&(d.B.Qa=c.ui.insertCountBadge),
"subsection"in c.ui&&(d.B.ua={},"begin"in c.ui.subsection&&(d.B.ua.Ka=c.ui.subsection.begin),"end"in c.ui.subsection&&(d.B.ua.end=c.ui.subsection.end)));"category"in c&&(d.D=c.category);"discourseTitle"in c&&(d.U=c.discourseTitle);return d}))));return b}
let la=(a,b,c)=>{const d=a.map(e=>ha(e).then(f=>{ia(f,e);const h=fa(f);try{ja(h,b,f.dcsTag,c)}catch(g){throw"string"===typeof g&&1<a.length&&(g=`In ${e} - ${g}`),g;}{let g=h.I;g&&(g.V=g.V&&(new URL(g.V,e)).href,g.W=g.W&&(new URL(g.W,e)).href,g.Y=g.Y&&(new URL(g.Y,e)).href)}h.Ea=f;return h},()=>{throw`<p>Failed to load <a href="${e}" target="_blank">${e}</a></p>`+'<o>Possible causes:</p><ol><li>File is missing (click on the above url, this should open your file in a new tab) </li><li>File is hosted at a "https://" url and your Discourse forum is at a "http://" url (or the other way around)</li><li>File is not in json format (in the new tab that you\'ve just opened, does it look like JSON?)</li><li>File has not been validated (please check with the <a href="https://sylque.github.io/dcs-website-schema/public/validate.html" target="_blank">Docuss Validation Tool</a>)</li><li>File is blocked by an ad-blocker (try to disable any ad-blockers and refresh the page)</li><li>File is hosted on a server that doesn\'t support CORS (open the <a href="https://kb.mailster.co/how-can-i-open-the-browsers-console/" target="_blank">browser console</a> and look for some red text about "CORS policy")</li></ol>';
}));return Promise.all(d).then(e=>{ka(e);return e})};function ia(a,b){a.pages.forEach(c=>{c.url=(new URL(c.url,b)).href})}
function ja(a,b,c,d){H(a.H);let e="contains invalid characters or doesn't comply with dcsTag="+JSON.stringify(c);a.o.forEach(g=>{if(!L(g.name,G.A))throw`Page name "${g.name}" ${e}`;if(g.pa&&!d)throw'Discourse setting "docuss proxy url" is required because a page has needsProxy=true';});a.P&&a.P.forEach(g=>{if(g=S(g))throw g;});if(a.l){if((c=a.l.v)&&!L(c,G.A-1))throw`Page name prefix "${c}" ${e}`;let g=(new URL(a.o[0].url)).origin;if(c=a.o.find(k=>(new URL(k.url)).origin!==g))throw`Invalid url "${c.url}": in a web app, all page urls should be of same origin`;
}if(a=a.clientData&&a.clientData.L){c=a.Ba||[];var f=(a.Fa||[]).map(g=>g.D),h=c.map(g=>g.D);[a.D,...f,...h].forEach(g=>{if(g&&!b.includes(g))throw`Category "${g}" not found`;});c.forEach(g=>{g.oa.forEach(k=>{if("@GENERATE@"===k||"@GENERATE_FROM_HTML_ID@"===k){if(1!==g.oa.length)throw`Reserved trigger id "${k}" must be alone in field "trigger.ids"`;}else if(!L(k,G.J))throw`Trigger id "${k}" ${e}`;})})}}
function ka(a){let b=a[0].H;for(let f=1;f<a.length;++f){let h=a[f].H;Object.keys(b).forEach(g=>{if(b[g]!==h[g])throw`Fields dcsTag.${g} are not equal across websites`;})}let c={};a.forEach(f=>{if(c[f.S])throw`Duplicate website name "${f.S}" across websites`;c[f.S]=!0});let d=a.filter(f=>f.l).map(f=>f.l);1<d.length&&d.forEach(f=>{if(!f.v)throw"webApp.otherPagesPrefix must not be empty when there are several web apps";if(d.find(h=>h!==f&&h.v.startsWith(f.v)))throw"overlapping webApp.otherPagesPrefix across web apps";
});let e={};a.forEach(f=>{f.o.forEach(h=>{if(e[h.name])throw`Duplicate page name "${h.name}" (across websites or within same website)`;e[h.name]=!0;let g=d.find(k=>k!==f.l&&h.name.startsWith(k.v));if(g)throw`Page name "${h.name}" collides with page name prefix "${g.v}"`;})})}let ha=a=>new Promise((b,c)=>{$.getJSON(a).done(d=>b(d)).fail((d,e)=>{c(e)})});
function S(a){let b=Object.assign({},1===a.src.b||a.src.pathname?{b:1,pathname:"bla"}:2===a.src.b||3===a.src.b||a.src.j||a.src.c?{b:2,a:"a",j:"DISCUSS"}:{b:0,a:"a"},a.src),c=T(b);if(c)return`Invalid redirect src - ${c}`;let d=Object.assign({},a.w);Object.keys(d).forEach(e=>{"@SAME_AS_SRC@"===d[e]&&(d[e]=b[e])});if(a=T(d))return`Invalid redirect dest - ${a}`}
function T(a){Object.keys(a).forEach(c=>{void 0!==a[c]&&""!==a[c]||delete a[c]});if(void 0===a.b||""===a.b)return"Missing layout";let b=1;if(a.hash){if(!a.hash.startsWith("#"))return`Invalid hash "${a.hash}"`;++b}switch(a.b){case 1:if(!a.pathname)return"Missing pathname";++b;break;case 2:case 3:if(!a.j)return"Missing interactMode";if(!["COMMENT","DISCUSS"].includes(a.j))return`Invalid interactMode "${a.j}"`;++b;if(a.c){if(!L(a.c,G.J))return`Invalid triggerId "${a.c}"`;++b}case 0:if(!a.a)return"Missing pageName";
let c=a.a.endsWith("*")?a.a.slice(0,-1):a.a;if(!L(c,G.A))return`Invalid pageName "${a.a}"`;++b;break;default:return`Invalid layout "${a.b}"`}if(Object.keys(a).length!==b)return`Too many arguments for layout "${a.b}"`}function U({method:a,path:b,ra:c}){return new Promise((d,e)=>{$.ajax({type:a,url:b,data:c,success:f=>d(f)}).fail(f=>e(f.responseText))})}function ma(){return U({method:"GET",path:"/categories.json"}).then(a=>a.category_list.categories)}
function na({tag:a}){return U({method:"GET",path:`/tags/${a}.json`}).then(b=>b.topic_list.topics)}function oa({title:a,content:b,xa:c,Ha:d}){return U({method:"POST",path:"/posts",ra:{title:a,raw:b,category:c,tags:d||[]}})}function pa({va:a}){return U({method:"DELETE",path:`/t/${a}.json`})}
function qa(a,b){return oa({title:"Temporary Docuss-generated topic "+Date.now(),content:"This topic was supposed to be removed and should not be there."+Date.now(),xa:b,Ha:a}).then(c=>v(2E3,c)).then(c=>pa({va:c.topic_id}))}
function ra(a){return ma().then(b=>x(b,c=>qa(a,c.id).then(()=>!0,d=>{console.log("discourseAPI.newTags(): cannot create topic.",d);return!1})).then(c=>{if(c)console.log("discourseAPI.newTags(): found a category to create a topic.",c);else throw"discourseAPI.newTags(): could not find a category where creating a topic is allowed.";}))}function sa({tag:a,ca:b}){return U({method:"PUT",path:`/tags/${a}/notifications`,ra:{tag_notification:{notification_level:b}}})}
function O(a,b){t(a.u);0!==b.b||b.a||(b.a=a.u[0].o[0].name);var c=T(b);c&&r(`Invalid route ${JSON.stringify(b)} - ${c}`);c=a.u.reduce((e,f)=>e.concat(f.P||[]),[]).concat(a.la||[]);if(c=V({src:b,P:c}))return W(a,{K:c,mode:"REPLACE",f:a.f}),!0;a.G=b;if(1===b.b)return a.i||(a.i=a.u[0],$("html").addClass(`dcs-website-${a.i.S}`),a.i.I&&a.g.m.ta(a.i.I)),X(a),!1;let d=null;c=a.u.find(e=>{d=e.o.find(f=>f.name===b.a);return!!d||e.l&&b.a.startsWith(e.l.v)});if(!c)return Y(a,"Page Not Found",`Unknown page "${b.a}".<br>`+
"Use the top left logo to come back to safety."),!1;if(c!==a.i){a.i&&$("html").removeClass(`dcs-website-${a.i.S}`);$("html").addClass(`dcs-website-${c.S}`);a.i=c;let e=Object.assign({},a.i.I,{href:a.i===a.u[0]?null:`/docuss/${a.i.o[0].name}`});a.g.m.ta(e);d=d||c.o[0]}if(!d)return X(a),!1;c=d.url;d.pa&&(c=new URL(c),c.protocol=a.X.protocol,c.hostname+="."+a.X.hostname,a.X.port&&(c.port=a.X.port),c=c.href);c!==a.ma?(a.f=null,ta(a,{url:c,Da:()=>{a.F&&(clearTimeout(a.F),a.F=null);X(a)}}),a.ma=c):X(a);
return!1}function Y(a,b,c){Q.disconnect();a.ma=null;ua().then(()=>{var d=a.g.h,e=`<h3>${b}</h3>${c}`;$(d.left).replaceWith(`    
      <div id="dcs-left" style="${d.left.style.cssText}">
        <div style="padding:20px">
          ${e}
        </div>
      </div>
    `);d.left=document.getElementById("dcs-left")});v(2E3).then(()=>{B(a.g.h,0)})}
function W(a,{K:b,mode:c,f:d}){let e=T(b);e&&r(`Invalid route ${JSON.stringify(b)} - ${e}`);if("PUSH"!==c&&"REPLACE"!==c)throw new q('setDiscourseRoute: missing or invalid argument "mode"');if(0===b.b)Z(a,{path:`/docuss/${b.a}`,hash:b.hash,mode:c,f:d});else if(1===b.b)Z(a,{path:b.pathname,mode:c,f:d});else{var {a:f,j:h,c:g}=b,k=K({a:f,c:g}),l=2===b.b?"?r=false":"";"DISCUSS"===h?Z(a,{path:`/tags/intersection/dcs-discuss/${k}${l}`,hash:b.hash,mode:c,f:d}):na({tag:k}).then(m=>{if(!m.length)return"not found";
m=m.find(va=>va.tags.includes("dcs-comment"));if(!m)throw new q("Error: no dcs-comment topic found in");Z(a,{path:`/t/${m.Ua}/${m.id}${l}`,hash:b.hash,mode:c,f:d});return"ok"},()=>"not found").then(m=>{"not found"===m&&Z(a,{path:`/tags/intersection/dcs-comment/${k}${l}`,hash:b.hash,mode:c,f:d})})}}function X(a){t(a.G);t(a.i);Q.isConnected()&&da({K:a.G,ya:a.i.Ea,aa:a.i.aa,f:a.f,origin:location.origin});a.f=null}
function ta(a,{url:b,Da:c}){Q.disconnect();let d=new URL(b);d.hash=location.hash;User.current()&&d.searchParams.set("discourse-login",!0);y(a.g.h,d.href);Q.connect({za:a.g.h.left,Aa:d.origin,Ca:c});a.F&&clearTimeout(a.F);a.F=setTimeout(()=>{var e=["For 10 seconds now, the Docuss plugin is trying to connect to "+`the iframe displaying this url: ${b}. Possible issues: `+"1. your Internet connection is slow and everything will be working fine once the iframe has finished loading 2. the page in the iframe does not include one of the Docuss client libraries (see more information at https://github.com/sylque/dcs-client).3. the page in the iframe is a web app which has crashed."];
e=[`%c${n()} %c- Docuss Warning -`,"color:grey","color:orange",...e];console.log(...e);a.F=null},1E4)}function Z(a,{path:b,hash:c,mode:d,f:e}){var f=a.g.lookup("router:main");f="PUSH"===d?f.transitionTo(b):f.replaceWith(b);let h=!!f.intent;h&&(a.f=e);let g=a.g.lookup("location:discourse-location");if(c!==g.location.hash){let k=c||b;f.then(()=>{"REPLACE"===d||h?g.replaceURL(k):g.setURL(k)})}}
class wa{constructor(a,b){this.g=b;this.F=this.la=this.f=this.G=this.O=this.u=null;var c=a.SiteSettings.docuss_website_json_file;if(c)if(c=c.split("|").filter(e=>!e.startsWith("DISABLE")),c.length)if(a.SiteSettings.tagging_enabled){var d=a.SiteSettings.docuss_proxy_url;if(d)try{this.X=new URL(d)}catch(e){Y(this,"Error in Discourse settings",'Invalid url in "docuss proxy url"');this.O=Promise.reject("Docuss error, see the home page");return}b=b.lookup("controller:application").site.categories.map(e=>
e.name);b=la(c,b,d).then(e=>{H(e[0].H);I();var f=3+G.A+G.J+2;var h=a.SiteSettings.max_tag_length;if(f>h)throw`dcsTag=${JSON.stringify(J())} implies a max tag length of ${f}, which doesn't match Discourse setting "max tag length"=${h}`;f=J().ba;h=a.SiteSettings.force_lowercase_tags;if(f!==h)throw`dcsTag.forceLowercase=${f} doesn't match Discourse setting "force lowercase tags"=${h}`;return e}).catch(e=>{if("string"===typeof e)throw Y(this,"Docuss - Error in website JSON file",e),"Docuss error, see the home page";
throw e;});c=U({method:"GET",path:"/tags.json"}).catch(e=>{"string"===typeof e&&Y(this,"Docuss - Error loading tags",e);throw e;});this.O=Promise.all([b,c]).then(e=>{this.u=e[0];let f=e[1].tags;e=g=>{if(!f.find(k=>k.id===g))throw Y(this,"Error in Docuss setup",`Missing required tag "${g}"`),"Docuss error - See the error message in the app";};e("dcs-comment");e("dcs-discuss");let h=f.reduce((g,k)=>{var l=k.id;k=k.count;0!==k&&(l=M(l))&&g.push({a:l.a,c:l.c,count:k});return g},[]);this.u.forEach(g=>
{let k=g.o.map(m=>m.name),l=h.filter(m=>k.includes(m.a)||g.l&&m.a.startsWith(g.l.v));g.aa=xa(l)})});Q.ea(this.ea.bind(this));Q.ga(this.ga.bind(this));Q.fa(this.fa.bind(this));Q.da(this.da.bind(this))}else Y(this,"Error in Discourse settings",'"tagging enabled" must be set to true'),this.O=Promise.reject("Docuss error, see the home page");else Y(this,"Error in Discourse settings",'All files in "docuss website json file" are disabled'),this.O=Promise.reject("Docuss error, see the home page");else Y(this,
"Error in Discourse settings",'At least one "docuss website json file" must be set'),this.O=Promise.reject("Docuss error, see the home page")}ea({K:a,mode:b,f:c}){W(this,{K:a,mode:b,f:c})}ga(a){let {error:b,D:c,U:d}=a;if(b)p(b),Y(this,b,"Use the top left logo to come back to safety.");else if(2===this.G.b||3===this.G.b){if(d){let e=ya(d);$(".dcs-title-prefix").remove();$(".tag-show-heading").text(e).css({display:"inline-flex"});let f=this.g.lookup("router:main");w(()=>{if(!f.currentPath.startsWith("topic."))throw"bad route";
const h=$(".fancy-title");return h.length&&h},15,200,"title not found").then(h=>{if("COMMENT"===this.G.j)h.text(e),h=$("#topic-title"),h.css("display","block"),$(".topic-map").length&&h.css("margin-top","50px");else{let g=this.g.lookup("controller:topic").get("model.title");h.html(`<span class="dcs-title-prefix">${e} | </span>${g}`)}},h=>{"bad route"!==h&&p(h)})}if(c)if(a=this.g.lookup("controller:application").site.categories.find(e=>e.name===c)){let e=this.g.lookup("controller:tags-show");e.set("category",
a);e.set("canCreateTopicOnCategory",!0)}else p(`Category "${c}" not found in Discourse`)}}fa(a){a.forEach(b=>{if(b=S(b))throw new q(b);});this.la=a;(a=V({src:this.G,P:a}))&&W(this,{K:a,mode:"REPLACE",f:null})}da(a){let {a:b,Ia:c,ca:d}=a;if(!b)throw new q('postCreateDcsTags: missing argument "pageName"');if(this.u.find(f=>f.o.find(h=>h.name===b)||f.l&&b.startsWith(f.l.v))){var e=c?c.map(f=>K({a:b,c:f})):[K({a:b,c:void 0})];ra(e).then(()=>{void 0!==d&&1!==d&&u(e,f=>sa({tag:f,ca:d})).catch(f=>{let h=
JSON.stringify(e);p(`Failed to set the notification level for one of those tags: ${h} (${f})`)})},f=>{let h=JSON.stringify(e);p(`Failed to create tags ${h}: ${f}`)})}else p(`Unable to create tag: page "${b}" not found`)}}let ua=()=>new Promise(a=>{Ember.run.schedule("afterRender",null,()=>a(void 0))});
function V({src:a,P:b}){b=b.find(d=>0===Object.keys(d.src).filter(e=>{const f=d.src[e];return"string"===typeof f&&f.endsWith("*")?!a[e]||!a[e].startsWith(f.slice(0,-1)):f!==a[e]}).length);if(!b)return null;let c=Object.assign({},b.w);Object.keys(c).forEach(d=>{"@SAME_AS_SRC@"===c[d]&&(c[d]=a[d])});return c}let za={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"},ya=a=>a.replace(/[&<>"']/g,b=>za[b]);
function xa(a){return a.map(b=>{let {a:c,c:d,count:e}=b;return{pageName:c,triggerId:d,count:e}})}let Aa=()=>new Promise(a=>{Ember.run.schedule("afterRender",null,()=>a(void 0))});
export function init(a,b){if(b.SiteSettings.docuss_enabled){SiteHeaderComponent.reopen({setTopic(){}});setDefaultHomepage("docuss");Aa().then(()=>{E(a)});var c=new wa(b,a);a.lookup("controller:application").reopen({queryParams:{showRight:"r"},showRight:!0});var d=a.lookup("-view-registry:main");a.m={ia:null,ja:null,ka:null,ha:null,ta(h){a.m.ia=h&&h.V;a.m.ja=h&&h.W;a.m.ka=h&&h.Y;a.m.ha=h&&h.href;h=$(".d-header").closest(".ember-view").attr("id");d[h].queueRerender()}};var e="",f=!0;withPluginApi("0.8.30",
h=>{h.reopenWidget("home-logo",{logoUrl(){return a.m.ia||this._super()},mobileLogoUrl(){return a.m.ja||this._super()},smallLogoUrl(){return a.m.ka||this._super()},href(){return a.m.ha||this._super()}});h.onAppEvent("page:changed",({["currentRouteName"]:g,["url"]:k})=>{if(k!==e){var l=k.split("?")[0]===e.split("?")[0];e=k;aa({g:a,M:c,R:g,N:l});f&&a.lookup("controller:composer").shrink();f=!0}})});ComposerController.reopen({La:Ember.observer("model.composeState",function(){if(this.get("model.composeState")===
Composer.OPEN){var h=this.get("model"),g=h.tags||h.topic&&h.topic.tags,k=g&&g.find(l=>M(l));k&&(g=(h=h.topic)?`/t/${h.slug}/${h.id}?r=true`:`/tags/intersection/${g.includes("dcs-comment")?"dcs-comment":"dcs-discuss"}/${k}?r=true`,f=!1,a.lookup("router:main").transitionTo(g))}}),Va:Ember.observer("model.tags",function(){let h=this.get("model"),g=h&&h.tags,k=g&&g.find(l=>M(l));k&&g.includes("dcs-comment")&&(h.setProperties({title:`Docuss comments (${k})`}),setTimeout(()=>{$("#reply-control .save-or-cancel .d-button-label").text("Add Comment")},
0))})});ApplicationRoute.reopen({Wa:Ember.observer("topicTrackingState.messageCount",function(){let h=this.controllerFor("application").topicTrackingState.states;ca(h)})})}};
